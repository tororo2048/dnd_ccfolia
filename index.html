<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&Dã‚·ãƒ¼ãƒˆ â†’ ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢é§’JSONç”Ÿæˆ (Cloudflareå¯¾å¿œ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 30px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #d81b60; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="url"] { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        textarea { width: 100%; height: 250px; padding: 15px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: monospace; font-size: 14px; background-color: #f9f9f9; resize: vertical; }
        button { background-color: #039be5; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0277bd; }
        .error { color: #d32f2f; background-color: #ffebee; border: 1px solid #ef9a9a; padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none; }
        .success { background-color: #e8f5e9; border: 1px solid #81c784; color: #388e3c; padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none; }
        .copy-button { background-color: #4CAF50; margin-left: 10px; }
        .copy-button:hover { background-color: #45a049; }
        .action-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>âœ¨ D&Dã‚·ãƒ¼ãƒˆ â†’ ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢é§’JSONç”Ÿæˆ (URLå¯¾å¿œ)</h1>
    <p>Cloudflare Workersã‚’ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦åˆ©ç”¨ã—ã€å¤–éƒ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆURLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚</p>

    <label for="sheet_url">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã®URL:</label>
    <input type="url" id="sheet_url" placeholder="ä¾‹: https://example.com/sheet.php?ID=54488" required>
    
    <div id="status-message" class="error"></div>
    
    <button id="generateButton" onclick="fetchSheetAndGenerateJson()">é§’JSONã‚’ç”Ÿæˆ</button>

    <div id="result-area" style="margin-top: 30px;">
        <h2>ğŸ‰ ç”Ÿæˆã•ã‚ŒãŸã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢é§’JSON</h2>
        <div class="action-row">
            <p id="summary-name" style="font-weight: bold;"></p>
            <button class="copy-button" id="copyButton" type="button" onclick="copyJson()">JSONã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
        <textarea id="jsonOutput" readonly></textarea>
        <div id="summary-area" style="margin-top: 10px; padding: 15px; background-color: #e9ecef; border-radius: 4px;">
            <h3>æŠ½å‡ºçµæœã‚µãƒãƒªãƒ¼</h3>
            <p id="summary-stats"></p>
        </div>
    </div>
</div>

<script>
    // ğŸš¨ ã“ã“ã‚’Cloudflare Worker/Functionã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ç½®ãæ›ãˆã¦ãã ã•ã„
    // ä¾‹: https://yourdomain.com/api/fetch-sheet
    const WORKER_ENDPOINT = 'https://dnd-pawn-scraper.tororo4096.workers.dev/'; 

    /**
     * D&Dã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã®HTMLå†…å®¹ã‹ã‚‰å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã¾ã™ã€‚
     * @param {string} htmlContent - Workerã‹ã‚‰å–å¾—ã—ãŸç”Ÿã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
     * @returns {object|null} æŠ½å‡ºã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‡ãƒ¼ã‚¿
     */
    function parseDnDSheet(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        
        const extractText = (selector, fallback = '0') => {
            const element = doc.querySelector(selector);
            let text = element ? element.textContent.trim() : '';
            return text.replace(/ã€€/g, '').replace(/[\n\r]/g, '');
        };

        try {
            // ã‚»ãƒ¬ã‚¯ã‚¿ã¯æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« (OUTPUT.php.txt) ã®æ§‹é€ ã‚’åŸºã«æ§‹ç¯‰
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:
            const name = extractText('table.DD5ePage tr:nth-child(2) td:nth-child(2) div.B b', 'ç„¡åã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼');
            
            // AC:
            [cite_start]const acText = extractText('table[summary="ï¼¡ï¼£"] tr.LWC td:nth-child(1) div.A b'); [cite: 18]
            const ac = parseInt(acText) || 10;

            // ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–:
            [cite_start]const initText = extractText('table[summary="ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–"] tr.LWC td:nth-child(1) div.A b'); [cite: 18]
            const initiative = parseInt(initText) || 0;

            // ç¿’ç†Ÿãƒœãƒ¼ãƒŠã‚¹ (PB):
            [cite_start]const pbText = extractText('table.DD5ePage[summary="3åˆ—ç›®"] table[width="340"] tr.MWC td:nth-child(4) div.A b'); [cite: 20]
            const pb = parseInt(pbText) || 2;

            // æœ€å¤§HP:
            // ãƒ’ãƒƒãƒˆãƒã‚¤ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®ã€æœ€å¤§HPã®è¡¨ç¤ºæ¬„ (é€šå¸¸ã¯ç©ºæ¬„ã®å ´åˆãŒã‚ã‚‹ãŸã‚ã€PHPã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ã§ç¢ºèª)
            // ğŸš¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®HPæ¬„ã¯ç©ºæ¬„ã®å ´åˆãŒã‚ã‚‹ãŸã‚ã€ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            // æ§‹é€ : table[summary:ãªã—] > tr > td.LBC:nth-child(1) div.A b
            const hpTable = doc.querySelector('table[summary]:last-of-type');
            const hpMaxElement = hpTable ? hpTable.querySelector('tr:nth-child(6) td.LBC:nth-child(1) div.A b') : null;
            const hpMax = parseInt(hpMaxElement ? hpMaxElement.textContent.trim() : '') || 1; 

            // HPç¾åœ¨å€¤:
            const hpCurrentElement = hpTable ? hpTable.querySelector('tr:nth-child(6) td.LBC:nth-child(2) div.A b') : null;
            const hpCurrent = parseInt(hpCurrentElement ? hpCurrentElement.textContent.trim() : '') || hpMax;

            if (name === 'ç„¡åã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼' && ac === 10) {
                 throw new Error("ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ã€ãƒšãƒ¼ã‚¸æ§‹é€ ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }


            return { name, ac, initiative, hp_max: hpMax, hp_current: hpCurrent, pb };

        } catch (e) {
            console.error("è§£æã‚¨ãƒ©ãƒ¼:", e);
            throw new Error(`HTMLã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
        }
    }

    function generateKokoforiaJsonData(data) {
        const { name, initiative, hp_current, hp_max, ac, pb } = data;

        const kokoforiaData = {
            kind: 'character',
            data: {
                name: name,
                init: initiative,
                memo: `D&Dã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•ç”Ÿæˆ\n\nAC: ${ac}\nç¿’ç†Ÿãƒœãƒ¼ãƒŠã‚¹: +${pb}`,
                secret: false,
                invisible: false,
                hideStatus: false,
                image: null,
                status: [
                    { label: 'HP', value: hp_current, max: hp_max },
                    { label: 'AC', value: ac, max: ac },
                ],
                chatPalette: 
                    "// --- D&D5E ãƒ­ãƒ¼ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆ ---\n" +
                    `1d20+${initiative} ã€ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–ã€‘\n` +
                    `1d20+${pb} ã€ç¿’ç†Ÿåˆ¤å®š (PB)ã€‘\n` +
                    "1d20+?{èƒ½åŠ›ä¿®æ­£|0} ã€èƒ½åŠ›å€¤åˆ¤å®šã€‘\n" +
                    "1d20+?{æŠ€èƒ½ä¿®æ­£|0} ã€æŠ€èƒ½åˆ¤å®šã€‘\n" +
                    "// ---- æ”»æ’ƒä¾‹ ----\n" +
                    "1d20+?{æ”»æ’ƒä¿®æ­£|0} ã€æ”»æ’ƒãƒ­ãƒ¼ãƒ«ã€‘\n" +
                    "?{ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ€ã‚¤ã‚¹|1d6}+?{ãƒ€ãƒ¡ãƒ¼ã‚¸ä¿®æ­£|0} ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‘\n",
            }
        };

        return JSON.stringify(kokoforiaData, null, 2);
    }
    
    async function fetchSheetAndGenerateJson() {
        const sheetUrl = document.getElementById('sheet_url').value;
        const statusMessage = document.getElementById('status-message');
        const jsonOutput = document.getElementById('jsonOutput');
        const generateButton = document.getElementById('generateButton');
        
        statusMessage.style.display = 'none';
        jsonOutput.value = '';
        generateButton.disabled = true;
        generateButton.textContent = 'å‡¦ç†ä¸­...';

        if (!sheetUrl.startsWith('http')) {
            setStatus('ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
            generateButton.disabled = false;
            generateButton.textContent = 'é§’JSONã‚’ç”Ÿæˆ';
            return;
        }
        
        try {
            // 1. Workerã‚’å‘¼ã³å‡ºã—ã€å¤–éƒ¨ãƒšãƒ¼ã‚¸ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            const workerUrl = `${WORKER_ENDPOINT}?url=${encodeURIComponent(sheetUrl)}`;
            const response = await fetch(workerUrl);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Workerã‹ã‚‰ã®å¿œç­”ã‚¨ãƒ©ãƒ¼: ${response.status} (${errorText.substring(0, 100)}...)`);
            }

            const htmlContent = await response.text();

            // 2. å–å¾—ã—ãŸHTMLã‚’è§£æã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            const data = parseDnDSheet(htmlContent);

            // 3. JSONã‚’ç”Ÿæˆã—ã€è¡¨ç¤º
            const json = generateKokoforiaJsonData(data);
            jsonOutput.value = json;
            
            // 4. ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            document.getElementById('summary-name').textContent = `ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å: ${data.name}`;
            document.getElementById('summary-stats').innerHTML = 
                `ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–: ${data.initiative} / AC: ${data.ac} / HP (ç¾åœ¨/æœ€å¤§): ${data.hp_current} / ${data.hp_max} / PB: +${data.pb}`;

            setStatus('âœ… é§’JSONãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚', false);

        } catch (e) {
            console.error(e);
            setStatus(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, true);
        } finally {
            generateButton.disabled = false;
            generateButton.textContent = 'é§’JSONã‚’ç”Ÿæˆ';
        }
    }

    function setStatus(message, isError) {
        const statusMessage = document.getElementById('status-message');
        statusMessage.textContent = message;
        statusMessage.className = isError ? 'error' : 'success';
        statusMessage.style.display = 'block';
    }

    function copyJson() {
        const jsonOutput = document.getElementById('jsonOutput');
        const copyButton = document.getElementById('copyButton');
        
        jsonOutput.select();
        jsonOutput.setSelectionRange(0, 99999);
        
        let success = false;
        try {
            success = document.execCommand('copy');
        } catch (err) {
            console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
        }

        if (success) {
            copyButton.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
        } else {
            copyButton.textContent = 'âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—';
        }

        setTimeout(() => {
            copyButton.textContent = 'JSONã‚’ã‚³ãƒ”ãƒ¼';
        }, 3000);
    }
</script>

</body>
</html>
